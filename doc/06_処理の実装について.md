# 処理の実装について

<!-- TOC -->

- [処理の実装について](#処理の実装について)
  - [各画面の開発の仕方](#各画面の開発の仕方)
    - [web.php](#webphp)
    - [XXX.blade.php](#xxxbladephp)
    - [XXX.js](#xxxjs)
      - [検索ボタン押下時](#検索ボタン押下時)
      - [詳細ボタン押下時(モーダル)](#詳細ボタン押下時モーダル)
      - [登録ボタン押下時](#登録ボタン押下時)
      - [変更ボタン押下時](#変更ボタン押下時)
      - [削除ボタン押下時](#削除ボタン押下時)
    - [XXXController.php](#xxxcontrollerphp)
  - [テーブルについて](#テーブルについて)
    - [テーブル定義](#テーブル定義)
    - [モデルの作成](#モデルの作成)

<!-- /TOC -->
※沼田さん作成のセレクティー様マイページ用資料を流用しています。  
画面ハードコピーなどは流用元のものになっているものが多いので、適時読み替えてください。  

## 各画面の開発の仕方

サーバーを起動します。

```
php artisan serve
```

以下のコマンドを実行しJSのビルドを行います。
ファイルに変更がある場合、自動でビルドしてくれます。
ターミナルが実行しっぱなしになるので、他のコマンド打つ場合は別途ターミナルを開いてください。  
(基本的に3つのターミナルが開かれている状態になると思います)

```
npm run dev
```

画面を開発する際は、以下の作業が必要です。

### web.php

追加する画面について、ルーティングを定義します。  
以下のようにコントローラを指定してください。  

```
// 一覧
Route::get('/sample', [SampleController::class, 'index'])->name('sample');
```

コントローラーを使わずテンプレートを返すだけのものは、以下のようにします。

```
// 例
Route::get('/viewonly_sample', function () {
    return view('pages.mypage-common.viewonly_sample');
})->name('viewonly_sample');
```

### XXX.blade.php

`resources\views\pages\`配下に、画面に対するテンプレートを作成します。  

画面の部品は、基本的にはコンポーネント化しており、テーブル、
テキストやカレンダーなどの入力項目などを共通化しています。  
(そこでバリデーションや変更時の値をセットしたりしている)

### XXX.js

`resources\js\pages\`配下に、画面ごとのJSファイルを作成します。  
XXX.blade.phpの名前と同じJSファイルを自動で読み込むようになっています。

page-base.jsが共通処理を記述しており、各画面のJSでは呼び出す程度の処理になっています。

ただし、コントローラに決まった処理を追加する必要があります。  
(ほぼ以下のパターンになるため、各ボタン押下処理は共通処理として実装した)

#### 検索ボタン押下時

- 検索項目のバリデーション  
/xxx/vd-search
- 検索結果一覧データの取得  
/xxx/search

#### 詳細ボタン押下時(モーダル)

- 詳細データ取得  
/xxx/get-data
- 確認モーダルのOKボタン押下時  
/xxx/exec

#### 登録ボタン押下時

- 入力項目のバリデーション  
/xxx/vd-input
- 新規登録処理  
/xxx/create

#### 変更ボタン押下時

- 入力項目のバリデーション  
/xxx/vd-input
- 変更処理  
/xxx/update

#### 削除ボタン押下時

- 削除処理  
/xxx/delete


### XXXController.php

`app\Http\Controllers\`配下に、画面ごとのコントローラを作成します。
各画面のサーバサイドの処理になります。  
一覧を表示する処理や、登録、更新、削除などの処理も記述します。

## テーブルについて

### テーブル定義

`database\migrations`配下に、テーブル定義の処理を作成します。  
履歴のように、差分を追加できます。（例えば列が追加になったなど）

参考：ユーザマスタ
```
Schema::create('users', function (Blueprint $table) {
    $table->id();
    $table->string('name');
    $table->string('email')->unique();
    $table->timestamp('email_verified_at')->nullable();
    $table->string('password');
    $table->rememberToken();
    $table->timestamps();
});
```

これにより、他の開発者（あるいは本番環境構築時も）は、以下のコマンドを打つことによってテーブルを最新の定義にすることができます。  
DDLが不要となります。

```
php artisan migrate
```

### モデルの作成

`app\Models`配下にモデル定義を作成します。  
1つのテーブルに対し、1つのモデルを作成します。  
既存のモデル定義を参考にして作成すれば良いです。

- 論理削除  
今回は論理削除としているため、以下の記述をいれています。
（物理的にレコードをDELETEするのではなく、`deleted_at`というカラムにタイムスタンプを入れることにより、見かけ上削除されたような挙動をさせる仕組み）

```
use SoftDeletes;
```


