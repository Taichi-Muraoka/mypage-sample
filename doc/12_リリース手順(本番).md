# リリース手順(本番)

<!-- TOC -->

- [リリース手順(本番)](#リリース手順本番)
  - [概要](#概要)
  - [js/cssのビルド・ビルドファイル格納（ローカル作業 ）](#jscssのビルド・ビルドファイル格納ローカル作業-)
  - [mainブランチへマージ（ローカル作業 ）](#mainブランチへマージローカル作業-)
    - [タグ付け](#タグ付け)
    - [マージ](#マージ)
    - [リリース登録](#リリース登録)
  - [最新化する手順（サーバ作業）](#最新化する手順サーバ作業)
    - [SSHでリモート](#sshでリモート)
    - [mainブランチへの切り替え（初回リリース時のみ）](#mainブランチへの切り替え初回リリース時のみ)
    - [事前準備（DBバックアップ等）](#事前準備dbバックアップ等)
    - [Git pull](#git-pull)
    - [キャッシュの削除・最適化](#キャッシュの削除最適化)
    - [JSビルドファイルのアップロード](#jsビルドファイルのアップロード)
    - [composerのアップデート(必要時のみ)](#composerのアップデート必要時のみ)
    - [テーブル定義の更新（テーブル定義に変更がある場合）](#テーブル定義の更新テーブル定義に変更がある場合)
    - [動作確認](#動作確認)

<!-- /TOC -->

※沼田さん作成のセレクティー様マイページ用資料を流用しています。  
画面ハードコピーなどは流用元のものになっているものが多いので、適時読み替えてください。  

## 概要

普段の開発は、developブランチを使用する。  
リリースする際に、mainブランチへマージする。

運用中のバージョンに対する障害対応の適用は、
hotfix-mergeブランチをベースとする。  
リリースする際に、masterブランチ・developブランチへマージする。  
（ブランチ運用は別途資料参照のこと）

以下の手順は、developブランチをベースとし、
developブランチのソースをmainブランチに反映・リリースすることを前提とする。  
**障害対応の場合は、ブランチ名をdevelop →hotfix-mergeに読み替えてください。**

## js/cssのビルド・ビルドファイル格納（ローカル作業 ）
（developブランチ）

VS-codeのターミナルにて、  
`npm run build` コマンドを実行し、本番用ビルドファイルを作成する。
（`npm run dev` コマンド実行中の場合は終了しておく）

`npm run build`が正常完了すると、public/buildフォルダにビルドファイルが生成される。  
（「dynamic import will not move module into another chunk.」のワーニングが出るがとりあえず無視してよい）

web-testea/public/buildフォルダの中のフォルダ・ファイルを
web-testea/public_buildに格納する。  
（public_buildフォルダのファイルを全て、TortoiseGitでDeleteしてから格納）

格納後にadd/commit/pushする。
(リリースしたものを管理するため)

## mainブランチへマージ（ローカル作業 ）

### タグ付け

バージョン管理を行うため、タグをつける。  
developブランチでTortoiseGitを使っている。

Create Tagを選択

![](./img/12_リリース手順(本番)/01.png)

タグをつける(バージョン)  
→例：v1.0.0  
メジャー番号.マイナー番号.パッチ番号

仕様変更や不具合対応時に、マイナーバージョン上げる。  
その際に、細かい対応を行った場合は、パッチ番号とする。  
メジャーバージョンは今の所不要かな。  

![](./img/12_リリース手順(本番)/02.png)

Include Tagsにチェックを入れてプッシュ

![](./img/12_リリース手順(本番)/03.png)

GitHub上にタグが付いていることを確認

![](./img/12_リリース手順(本番)/04.png)


### マージ

mainブランチへ切り替え(checkout) 

![](./img/12_リリース手順(本番)/05.png)
![](./img/12_リリース手順(本番)/06.png)


Mergeをクリックし、マージする。  
Fromにdevelopを指定する

![](./img/12_リリース手順(本番)/07.png)
![](./img/12_リリース手順(本番)/08.png)

マージ後、プッシュボタンをクリックして、プッシュする

![](./img/12_リリース手順(本番)/09.png)


終わったら、developブランチへ切り替えておく(checkout) 

![](./img/12_リリース手順(本番)/10.png)

### リリース登録

GitHubのCreate a new releaseをクリック

![](./img/12_リリース手順(本番)/11.png)

バージョンとリリース情報を入れて、publish releaseボタン押下。

![](./img/12_リリース手順(本番)/12.png)


バージョンとして登録される。

![](./img/12_リリース手順(本番)/13.png)


## 最新化する手順（サーバ作業）

### SSHでリモート

さくらのサーバーへSSHクライアントで接続・ログインを行う。  
サーバ管理者に、本番環境のログイン情報などを確認する。

### mainブランチへの切り替え（初回リリース時のみ）

developブランチで既に公開中の場合、mainブランチに切り替える。  

```
git fetch origin main
git checkout -b main origin/main
```

次回以降は、カレントブランチがmainとなっているはずなので切替は不要。  
以下のコマンドでカレントブランチを確認。  
```
git branch
```

### 事前準備（DBバックアップ等）

本番サーバなので、**freshをつけてのmigrateなどを行わないように注意**が必要。  
何かあったときのために、最新化の前にDBのバックアップは取りましょう。

バッチコマンドでDBバックアップを行う。  
git/testea-mypage/source/web-testea/storage/app/db_backup配下にバックアップファイルが作成されていることを確認する。
```
php artisan command:dbBackup
```

作業時にBasic認証かけたほうがよいかも。PJで決めておく

### Git pull

git/testea-mypage/source/web-testeaにて、  
git pullする。(mainブランチ)  
パスフレーズはサーバ管理者に確認する。

```
git pull
```

### キャッシュの削除・最適化

```
composer dump-autoload
php artisan clear-compiled
php artisan optimize
```

以下も実行し、キャッシュを削除。

```
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear
```

### JSビルドファイルのアップロード

FTPツールにて、サーバーに接続。  
サーバーにあるpublic/buildフォルダを丸ごと削除し、  
ローカルのpublic/buildフォルダを一式アップロードする。（バイナリ転送）  


アップロード先
```
/git/testea-mypage/source/web-testea/public
```

### composerのアップデート(必要時のみ)

Composer管理のパッケージに変更があった場合のみ実施。  
composer.lockをプッシュし、サーバーではpullした上で以下のコマンドを実行

```
composer install
```

### テーブル定義の更新（テーブル定義に変更がある場合）

※テーブル定義変更手順については別途確認  
**fresh厳禁！！**

```
php artisan migrate
```

### 動作確認

サーバーにアクセスし、問題なく動作するか確認する。  
作業時にBasic認証をかけていた場合は、元に戻す。  


