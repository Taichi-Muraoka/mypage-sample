# さくらのサーバー構築(開発SV)

<!-- TOC -->

- [さくらのサーバー構築(開発SV)](#さくらのサーバー構築開発sv)
  - [概要](#概要)
  - [git clone 準備作業（サーバ作業）](#git-clone-準備作業サーバ作業)
    - [SSHでリモート](#sshでリモート)
    - [sshキーの作成](#sshキーの作成)
    - [キーペアの確認](#キーペアの確認)
  - [git clone 準備作業（GitHub）](#git-clone-準備作業github)
    - [GitHubに登録](#githubに登録)
  - [Gitでlaravelプロジェクトのクローン（サーバ作業）](#gitでlaravelプロジェクトのクローンサーバ作業)
  - [Laravelの構築（サーバ作業）](#laravelの構築サーバ作業)
  - [データベースの作成](#データベースの作成)
  - [プロジェクトの設定（サーバ作業）](#プロジェクトの設定サーバ作業)
    - [.envファイルの作成](#envファイルの作成)
    - [テーブル作成](#テーブル作成)
    - [PDFの設定](#pdfの設定)
  - [プロジェクトの公開](#プロジェクトの公開)
    - [シンボリックリンク設定等](#シンボリックリンク設定等)
    - [ドメイン設定](#ドメイン設定)
    - [アクセスログ設定](#アクセスログ設定)
    - [php.ini設定](#phpini設定)
  - [JSファイルのビルド・アップロード](#jsファイルのビルドアップロード)
  - [表示確認](#表示確認)

<!-- /TOC -->

※沼田さん作成のセレクティー様マイページ用資料を流用しています。  
画面ハードコピーなどは流用元のものになっているものが多いので、適時読み替えてください。  

## 概要

さくらのレンタルサーバーへ、Laravelプロジェクトをデプロイし動作するまでの手順をまとめる。  

今後の参考のために、さくらのレンタルサーバーへ、Laravelが動作する手順をまとめる。  

以下ができるよう、事前にツール等のインストール・設定を行う。  
サーバ管理者に、開発SV環境のログイン情報などを確認しておく。

- FTPで接続できること（WinSCPなどのFTPクライアントソフトを使用）
- SSHで接続できること（TeraTerm、PuTTYなどのSSHクライアントソフトを使用）


## git clone 準備作業（サーバ作業）

### SSHでリモート

さくらのサーバーへSSHクライアントで接続・ログインを行う。  
以下、SSHで作業

### sshキーの作成

メアドは任意  
この後パスフレーズの入力を求められるが、任意
（パスフレーズは、git clone、git pull実行時に必要となるので、サーバ作業者で共有）

```
ssh-keygen -t rsa -b 4096 -C mikiko.toba@co-works.co.jp
```

### キーペアの確認

以下のファイルの中身を確認  
`/.ssh/id_rsa.pub`

```
ssh-rsa AAAAB3NzaC1yc2...
```

## git clone 準備作業（GitHub）

### GitHubに登録 

GitHubのリポジトリを開き、設定を開く。

![](./img/13_さくらのサーバー構築(開発SV)/01.png)

Deploy keysを開き、Add Deploy keyをクリック

タイトルは任意、Keyには/.ssh/id_rsa.pubの内容をペーストする。  
書き込み権限は不要。

![](./img/13_さくらのサーバー構築(開発SV)/02.png)


## Gitでlaravelプロジェクトのクローン（サーバ作業）


Gitのconfigファイルの作成

```
vi ~/.ssh/config
```

ユーザ情報を入力。  
サーバからはpushしないのでユーザ情報は任意で。

```
Host github.com
  HostName github.com
  IdentityFile ~/.ssh/id_rsa
  User testea.sakura
```


ルート直下にgitというディレクトリを作成  
その下にブランチ名のディレクトリを作成  
（モック用ブランチ・開発用ブランチを同居させる場合などを考慮）

```
mkdir git
cd git
mkdir develop
```

Cloneする。  
パスフレーズを入れる。

```
cd develop
git clone git@github.com:cw-develop/testea-mypage.git
```
develop配下に、ソースがcloneされていることを確認。

デプロイの対象からdoc配下を外す場合に以下も設定

```
cd testea-mypage
git config core.sparsecheckout true
vi .git/info/sparse-checkout
```

以下の一行を追記して保存

```
/source/web-testea/
```

以下を実行し、sourceフォルダのみになっていることを確認

```
git read-tree -m -u HEAD
```

カレントブランチの確認。  
```
git branch --list
```

開発SV環境で、developブランチを参照することを想定。
上記でdevelopがカレントでない場合、ブランチの切り替えを行う。  

```
git checkout develop
```


## Laravelの構築（サーバ作業）

SSHで作業。  
composerをインストール

```
cd
mkdir bin

curl -sS https://getcomposer.org/installer | php -- --install-dir=bin --filename=composer
chmod 755 bin/composer
```


ディレクトリに権限を与える

```
cd git/develop/testea-mypage/source/web-testea/
chmod -R 777 storage/
chmod -R 777 bootstrap/cache/
```

プロジェクトで使用しているライブラリなどをComposerでインストール

```
php /home/dev-testea/bin/composer install
php /home/dev-testea/bin/composer dump-autoload
```


## データベースの作成

さくらのコントロールパネルから作成する。  
以下のURLよりログイン。  
（初期ドメイン名とサーバパスワードを入力）  
https://secure.sakura.ad.jp/rs/cp/

ホーム画面のショートカットより、「データベース」を選択。  
データベースの画面で「新規作成」ボタン押下。

![](./img/13_さくらのサーバー構築(開発SV)/03.png)

データベース新規作成画面にて、データベース名・パスワードを入力し、「作成する」ボタン押下。  
（モック用の仮DBの場合は、「laravel-mock」などわかるように名前を付ける）

![](./img/13_さくらのサーバー構築(開発SV)/04.png)


## プロジェクトの設定（サーバ作業）

### .envファイルの作成

SSHで作業。  

プロジェクト（web-testea）の直下に、.envファイルを作成する。
（.env.exampleをコピーする）

キーをリセット

```
php artisan key:generate
```

以下参考に追記・修正する(抜粋)
DB環境・メールサーバ情報は環境に合わせて設定する

```
# 欠席申請時の送信先管理者アドレス
MAIL_ABSENT_TO_ADDRESS=support@apple-mypage.sakura.ne.jp

APP_NAME=個別指導塾テスティー
APP_ENV=production
APP_KEY=base64:xxx
APP_DEBUG=false
APP_URL=https://testea-mypage.com
URL_PASSWORD_RESET=https://testea-mypage.com/password/reset

LOG_CHANNEL=stack

DB_CONNECTION=mysql
DB_HOST=mysqlxxx.db.sakura.ne.jp
DB_PORT=3306
DB_DATABASE=apple-mypage_laravel-mypage
DB_USERNAME=apple-mypage
DB_PASSWORD=xxx

# メールサーバ
MAIL_MAILER=log
#MAIL_MAILER=smtp
#MAIL_HOST=testea-mypage.sakura.ne.jp
#MAIL_PORT=587
#MAIL_USERNAME=
#MAIL_PASSWORD=xxx
#MAIL_ENCRYPTION=tls
```

### テーブル作成

```
php artisan migrate
```

必要に応じてseederで初期データ登録
```
php artisan db:seed --class=MypageDummyDataSeeder
```

### PDFの設定

PDF出力機能を使用する場合
```
cd /home/dev-testea/git/testea/develop/testea-mypage/source/web-testea
php ./vendor/tecnickcom/tcpdf/tools/tcpdf_addfont.php -b -t TrueTypeUnicode -f 32 -i ./resources/fonts/ipaexg.ttf
```


## プロジェクトの公開

### シンボリックリンク設定等

Laravelの公開ディレクトリのシンボリックリンクを貼る。
さくらの場合、初期ドメインはwww直下が固定になっているので、以下の対応を行う。

```
ln -s /home/dev-testea/git/testea/develop/testea-mypage/source/web-testea/public /home/dev-testea/www/laravel-testea
```


### ドメイン設定

さくらの管理画面から設定する。  

左側メニューより、ドメイン/SSL -> ドメイン/SSL を選択。  
ドメイン/SSLの画面で「新規作成」ボタン押下。

![](./img/13_さくらのサーバー構築(開発SV)/05.png)

開発環境の場合、「さくらインターネットのサブドメインを使う」より、無料のサブドメインを使用していた。
（２つまで使用可能）  


ドメイン設定を変更  
シンボリックリンクで設定したリンク名（www配下）を「web公開フォルダ」に設定する。

![](./img/13_さくらのサーバー構築(開発SV)/06.png)
![](./img/13_さくらのサーバー構築(開発SV)/07.png)


### アクセスログ設定

左側メニューより、サーバーステータス -> アクセスログ を選択。  
アクセスログを残す設定にする。

![](./img/13_さくらのサーバー構築(開発SV)/08.png)


### php.ini設定

左側メニューより、スクリプト設定 -> php.ini設定 を選択。  
PHP.iniでアップロードサイズなど必要に応じて変更

![](./img/13_さくらのサーバー構築(開発SV)/09.png)


## JSファイルのビルド・アップロード

最新化手順を参照し、ローカル環境でのJSファイルのビルド、JSビルドファイルのアップロードを行う。


## 表示確認

ドメインにアクセスして画面が表示されたらOK  
https://testea-dev.rulez.jp/


