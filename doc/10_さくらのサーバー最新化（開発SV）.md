# さくらのサーバー最新化手順（開発サーバ）
<!-- TOC -->

- [さくらのサーバー最新化手順（開発サーバ）](#さくらのサーバー最新化手順開発サーバ)
  - [最新化する手順](#最新化する手順)
    - [ローカル作業　JSファイルのビルド（本番用ビルドファイル作成）](#ローカル作業jsファイルのビルド本番用ビルドファイル作成)
    - [SSHでサーバーにリモート接続](#sshでサーバーにリモート接続)
    - [ブランチの確認](#ブランチの確認)
    - [Git pull](#git-pull)
    - [キャッシュの削除](#キャッシュの削除)
    - [JSビルドファイルのアップロード](#jsビルドファイルのアップロード)
    - [composerのアップデート(必要時のみ)](#composerのアップデート必要時のみ)
    - [テーブル定義の更新（テーブル定義に変更がある場合）](#テーブル定義の更新テーブル定義に変更がある場合)
    - [動作確認](#動作確認)

<!-- /TOC -->

※沼田さん作成のセレクティー様マイページ用資料を流用しています。  
画面ハードコピーなどは流用元のものになっているものが多いので、適時読み替えてください。  

## 最新化する手順

### ローカル作業　JSファイルのビルド（本番用ビルドファイル作成）

VS-codeのターミナルにて、  
`npm run build` コマンドを実行し、本番用ビルドファイルを作成する。
（`npm run dev` コマンド実行中の場合は終了しておく）

`npm run build`が正常完了すると、public/buildフォルダにビルドファイルが生成される。

### SSHでサーバーにリモート接続

さくらのサーバーへSSHクライアントで接続・ログインを行う。  
サーバ管理者に、ログイン情報などを確認する。

### ブランチの確認
```
cd /home/dev-testea/git/testea/develop/testea-mypage
git branch --list
```
実行結果（*がついているのが現在のブランチ）  
```
* develop
```


### Git pull

/home/dev-testea/git/testea/develop/testea-mypage/ 配下で、pullする。  
パスフレーズは戸羽に聞いてください。  

```
git pull
```

### キャッシュの削除

/home/dev-testea/git/testea/develop/testea-mypage/source/web-testea 配下で実行  
```
composer dump-autoload
php artisan clear-compiled
php artisan optimize
```

以下も実行し、キャッシュを削除。

```
php artisan cache:clear
php artisan config:clear
php artisan route:clear
php artisan view:clear
```

### JSビルドファイルのアップロード

FTPツールにて、サーバーに接続。  
サーバーにあるpublic/buildフォルダを丸ごと削除し、  
ローカルのpublic/buildフォルダを一式アップロードする。（バイナリ転送）  


### composerのアップデート(必要時のみ)

Composer管理のパッケージに変更があった場合のみ実施。  
composer.lockをプッシュし、サーバーではpullした上で以下のコマンドを実行

```
composer install
```

### テーブル定義の更新（テーブル定義に変更がある場合）

テーブル定義変更手順については別途確認

```
php artisan migrate
```

### 動作確認

サーバーにアクセスし、問題なく動作するか確認する。


